<!DOCTYPE html>
<html lang="en">

<head>
    <title>DrawWith</title>
    <link rel="stylesheet" type="text/css" href="/css/reset.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <meta name="theme-color" content="#82A43A">
</head>

<body>
    <canvas id="canvas" width=500 height=500>Please update your browser to one which supports HTML5 canvas.</canvas>
    <input class="color" id="color-picker" value="000000"></input>
    <button id="eyedropper">Eyedropper</button>
    <button id="clear">Clear</button>
    <div>
        <a href="javascript:void(0);" onclick="toImage('window'); return false;">New Window</a>
        <a href="javascript:void(0);" onclick="toImage('download'); return false;">Download</a>
    </div>
    <script src="https://cdn.socket.io/socket.io-1.3.6.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="/javascript/movement.js"></script>
    <script src="/javascript/save-image.js"></script>
    <script src="/jscolor/jscolor.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            var socket = io();
            socket.emit('join', window.location.pathname);
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");
            var paint;
            var drawingQueue = [];
            var clientTasks = [];
            var toServer = [];
            var clientID;

            socket.on("welcome", function(id) {
                clientID = id;
            });

            $(canvas).on("mousedown", function(event) {
                coords = canvas.relMouseCoords(event);
                var drawObj = {
                    'id': clientID,
                    'action': 'begin',
                    'coords': {
                        'x': coords.x,
                        'y': coords.y
                    },
                    'color': $("#color-picker").css("background-color"),
                    'penSize': 5,
                    'discard': false
                };
                paint = true;
                drawingQueue.push(drawObj);
            });

            $(canvas).on("mousemove", function(event) {
                if (paint) {
                    coords = canvas.relMouseCoords(event);
                    var drawObj = {
                        'id': clientID,
                        'action': 'continue',
                        'coords': {
                            'x': coords.x,
                            'y': coords.y
                        },
                        'discard': false
                    };
                    drawingQueue.push(drawObj);
                }
            });

            $(canvas).on("mouseup", function(event) {
                paint = false;
                coords = canvas.relMouseCoords(event);
                var drawObj = {
                    'id': clientID,
                    'action': 'end',
                    'coords': {
                        'x': coords.x,
                        'y': coords.y
                    },
                    'discard': false
                };
                drawingQueue.push(drawObj);
            });

            $(canvas).on("mouseleave", function(event) {
                if (paint) {
                    paint = false;
                    coords = canvas.relMouseCoords(event);
                    var drawObj = {
                        'id': clientID,
                        'action': 'end',
                        'coords': {
                            'x': coords.x,
                            'y': coords.y
                        },
                        'discard': false
                    };
                    drawingQueue.push(drawObj);
                }
            });

            $("#clear").on("click", function(event) {
                socket.emit("clear");
            });

            socket.on("clear", function() {
                canvas.width = canvas.width;
                canvas.height = canvas.height;
            });

            socket.on("persist", function(history) {
                drawingQueue = history;
            });

            $("#eyedropper").on("click", function() {
                var grabColor = true;
                $(canvas).on("click", function(event) {
                    if (grabColor) {
                        var pickloc = canvas.relMouseCoords(event);
                        var color = ctx.getImageData(pickloc.x, pickloc.y, 1, 1).data;
                        var rgbColor;
                        rgbColor = rgb(color[0], color[1], color[2]);
                        $("#color-picker").css("background-color", rgbColor);
                        grabColor = false;
                    }
                });
            });

            function rgb(r, g, b) {
                return ["rgb(", r, ",", g, ",", b, ")"].join("");
            }

            socket.on("path", function(list) {
                var externalPath = [];
                list.forEach(function(item) {
                    if (item.id != clientID) {
                        externalPath.push(item);
                    }
                });
                drawingQueue.push.apply(drawingQueue, externalPath);
            });

            function draw() {
                var task = drawingQueue.shift();
                if (task) {
                    if (task.action == 'begin') {
                        clientTasks[task.id] = {
                            'coords': task.coords,
                            'color': task.color,
                            'penSize': task.penSize
                        };
                    }
                    var previous = clientTasks[task.id];
                    var pastX = previous.coords.x;
                    var pastY = previous.coords.y;
                    var currX = task.coords.x;
                    var currY = task.coords.y;
                    ctx.strokeStyle = previous.color;
                    ctx.lineJoin = "round";
                    ctx.lineWidth = previous.penSize;
                    ctx.beginPath();
                    ctx.moveTo(pastX, pastY);
                    ctx.lineTo(currX, currY);
                    ctx.closePath();
                    ctx.stroke();

                    clientTasks[task.id].coords = task.coords;
                    if (!task.discard) {
                        task.discard = true;
                        toServer.push(task);
                    }
                }
            }

            window.setInterval(draw, 0);

            window.setInterval(function() {
                if (toServer.length > 0) {
                    var send = toServer;
                    socket.emit("path", toServer);
                    for (var i = 0; i < send.length; i++) {
                        toServer.shift();
                    }
                }
            }, 16);
        });
    </script>
</body>

</html>
